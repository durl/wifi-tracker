#!/usr/bin/python
"""Wifi Tracker.

Usage:
    {basename} sniff <interface> [options]
    {basename} show [<device_mac>] [options]
    {basename} kill
    {basename} -h | --help
    {basename} --version

Options:
    -h --help           Show help.
    --debug             Print debugging messages.
    --nooui             Omit OUI vendor lookup. This might be usefull if
                        no internet connection is availaible.

Commands:
    sniff           Sniff probe requests sent by devices in your area.
    show            Show all tracked devices.
    kill            Kill the last startet sniffer process.
"""

import datetime
import logging
import os

from docopt import docopt
from wifitracker import __version__


log = logging.getLogger(__name__)

if __name__ == "__main__":
    # parse commandline options:
    args = docopt(__doc__.format(basename=__file__), version=__version__)
    if args['--debug']:
        logging.getLogger().setLevel(logging.DEBUG)
    log.debug(args)

    # execute command:
    if args['sniff']:
        from wifitracker import sniffer
        log.info("PID: {}".format(os.getpid()))
        with open('/var/opt/wifi-tracker/pid.lock', 'w') as file:
            file.write(str(os.getpid()))
        try:
            start_dts = datetime.datetime.now()
            sniffer.sniff(args['<interface>'])
        except Exception as e:
            print e
    elif args['show']:
        from wifitracker.tracker import Tracker, json_pretty
        tracker = Tracker('/var/opt/wifi-tracker')
        oui_lookup = not args['--nooui']
        devices = tracker.get_devices(load_dts=datetime.datetime.now(),
                                      oui_lookup=oui_lookup)
        for id in devices:
            print json_pretty(devices[id])
    elif args['kill']:
        with open('/var/opt/wifi-tracker/pid.lock', 'r') as file:
            pid = int(file.read())
        os.kill(pid, 9)
